name: CD Pipeline

on:
  push:
    branches: [ main ]

  workflow_dispatch:

jobs:
  deploy-to-ec2:
    runs-on: ubuntu-latest

    steps:
      # ë ˆí¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # JDK ì„¸íŒ…
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # í…ŒìŠ¤íŠ¸ ì œì™¸ ë¹Œë“œ
      - name: Build with Gradle for deployment
        run: ./gradlew clean build -x test

      # DockerHub ë¡œê·¸ì¸
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Docker ì´ë¯¸ì§€ ë¹Œë“œ + latest íƒœê·¸ push
      - name: Build and Push Docker image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/web2:latest .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/web2:latest

      # EC2ì— SSH ì—ì´ì „íŠ¸ ì„¤ì •
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # EC2ì—ì„œ ìµœì‹  ì´ë¯¸ì§€ pull, ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
      - name: Deploy to EC2
        env:
          HOST: ${{ secrets.EC2_HOST }}
          USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          ssh -o StrictHostKeyChecking=no "$USERNAME@$HOST" "
            cd ~/37-SOPKATHON-SERVER-WEB2
          
            echo 'ğŸ¤“ DockerHubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.'
            docker compose pull

            echo 'ğŸ¤“ ì‹¤í–‰ì¤‘ì¸ ì»¨í…Œì´ë„ˆë¥¼ ì¤‘ì§€, ì‚­ì œí•©ë‹ˆë‹¤.'
            docker compose down || true

            echo 'ğŸ¤“ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆë¥¼ ë„ì›ë‹ˆë‹¤.'
            docker compose up -d

            echo 'ğŸ¤“ ì‚¬ìš©ë˜ì§€ ì•Šì€ ì´ë¯¸ì§€ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.'
            docker image prune -f
          "
